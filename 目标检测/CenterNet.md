# Preliminary
- 输入图像:$I \in R^{W \times H \times 3}$
- 目标:得到一幅热力图$\hat{Y} \in [0,1]^{\frac{W}{R}\times \frac{H}{R} \times C}$
  - R表示降采样比例,默认为4
  - C:在目标检测中代表类别,默认80;在姿态识别中代表人体关节,默认17
  - 热力图的值:1代表检测到的关键点,0代表background
- 训练真值
  - 中心点:$Y_{x y c}=\exp \left(-\frac{\left(x-\tilde{p}_{x}\right)^{2}+\left(y-\tilde{p}_{y}\right)^{2}}{2 \sigma_{p}^{2}}\right)$:热力图上每个坐标的真值,如果同一类的两个高斯分布重叠则取值更大的作为热力图上的中心点真值
    - $p=\left(\frac{x_{1}+x_{2}}{2}, \frac{y_{1}+y_{2}}{2}\right)$,框的中心点
    - $\tilde{p}=\left\lfloor\frac{p}{R}\right\rfloor$,中心点在热力图的坐标
    - $\sigma_{p}$:对象尺寸自适应 标准差
- 损失函数
  - 中心点Focal Loss:$L_{k}=\frac{-1}{N} \sum_{x y c}\left\{\begin{array}{cc}\left(1-\hat{Y}_{x y c}\right)^{\alpha} \log \left(\hat{Y}_{x y c}\right) & \text { if } Y_{x y c}=1 \\ \left(1-Y_{x y c}\right)^{\beta}\left(\hat{Y}_{x y c}\right)^{\alpha} \log \left(1-\hat{Y}_{x y c}\right) & \text { otherwise }\end{array}\right.$
    - 论文中取值$\alpha=2,\beta=4$
    - 当 $Y_{x y c}=1$ 时，假如 $\hat{Y}_{x y c}$ 接近1，说明这是个比较容易检测出来的点，那么 $\left(1-\hat{Y}_{x y c}\right)^{\alpha}$ 就相应比较低。而当 $\hat{Y}_{x y c}$ 接近0的时候，说明这个中心点还没有学习到，所以要加大其训练的比重，因此 $\left(1-\hat{Y}_{x y c}\right)^{\alpha}$ 就会很大。负样本挖掘
    - otherwise,$\left(1-Y_{x y c}\right)^{\beta}$:与中心点距离越近，$Y_{x y c}$越接近1，这个值越小，相反则越大。$\left(\hat{Y}_{x y c}\right)^{\alpha}$的预测值理应是0，如果不为0的且越来越接近1的话，$\left(\hat{Y}_{x y c}\right)^{\alpha}$的值就会变大从而使这个损失的训练比重也加大。考虑与中心点距离(着重于远的点)和负样本挖掘。
  - 目标中心的偏置损失:$L_{o f f}=\frac{1}{N} \sum_{p}\left|\hat{O}_{\tilde{p}}-\left(\frac{p}{R}-\tilde{p}\right)\right|$
    - 降低图像缩放导致的精度损失，非重点
  - 目标大小的损失:假设$\left(x_{1}^{(k)}, y_{1}^{(k)}, x_{2}^{(k)}, y_{2}^{(k)}\right)$为目标$k$，所属类别为$c_{k}$，它的中心点为$p_{k}=\left(\frac{x_{1}^{(k)}+x_{2}^{(k)}}{2}, \frac{y_{1}^{(k)}+y_{2}^{(k)}}{2}\right)$，用关键点预测 $\hat{Y}$ 去预测所有的中心点，然后对每个目标$k$的size进行回归，最终回归到$s_{k}=\left(x_{2}^{(k)}-x_{1}^{(k)}, y_{2}^{(k)}-y_{1}^{(k)}\right)$
    - $L_{\text {size}}=\frac{1}{N} \sum_{k=1}^{N}\left|\hat{S} p_{k}-s_{k}\right|$
  - 总损失:$L_{d e t}=L_{k}+\lambda_{s i z e} L_{s i z e}+\lambda_{o f f} L_{o f f}$
  - 在论文中$\lambda_{\text {size}}=0.1$，然后$\lambda_{o f f}=1$ ，论文中所使用的backbone都有三个head layer，分别产生[1,80,128,128]、[1,2,128,128]、[1,2,128,128]，也就是每个坐标点产生 $C+4$个数据，分别是类别以及、长宽、以及偏置。
- Test阶段
  - 采用3x3的maxpool提取100个大于或等于周围$\hat{Y}_{xyc}$的热力点
    - maxpool提取多个热力点，保留置信度最高的100个热力点
  - 假设其中一个热力点:$\hat{\mathcal{P}}=\left\{\left(\hat{x}_{i}, \hat{y}_{i}\right)\right\}_{i=1}^{n}$。$\hat{Y}_{x_{i} y_{i} c}$代表置信度
    - 最终保留置信度大于0.3的检测框
  - 预测框:$\left( \hat{x}_{i}+\delta \hat{x}_{i}-\hat{w}_{i} / 2, \hat{y}_{i}+\delta \hat{y}_{i}-\hat{h}_{i} / 2\right. . \quad \left. \hat{x}_{i}+\delta \hat{x}_{i}+\hat{w}_{i} / 2, \hat{y}_{i}+\delta \hat{y}_{i}+\hat{h}_{i} / 2\right) $